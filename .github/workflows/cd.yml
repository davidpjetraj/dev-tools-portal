name: CD

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  deploy:
    name: Deploy to docker-desktop
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    runs-on: [self-hosted, windows, docker-desktop]
    permissions:
      contents: read
    defaults:
      run:
        shell: powershell

    env:
      NAMESPACE: dev-tools-portal
      IMAGE_API: ghcr.io/davidpjetraj/dev-tools-portal/api
      IMAGE_WEB: ghcr.io/davidpjetraj/dev-tools-portal/web
      IMAGE_TAG: ${{ github.event.workflow_run.head_sha }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      ADMIN_USERNAME: ${{ secrets.ADMIN_USERNAME }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Verify kubectl context
        run: kubectl config current-context

      - name: Ensure namespace exists
        run: kubectl apply -f deploy/k8s/namespace.yaml

      - name: Validate required deployment secrets
        run: |
          $required = @('MONGODB_URI', 'JWT_SECRET', 'ADMIN_USERNAME', 'ADMIN_PASSWORD')
          $missing = @()
          foreach ($name in $required) {
            $value = [System.Environment]::GetEnvironmentVariable($name)
            if ([string]::IsNullOrWhiteSpace($value)) {
              $missing += $name
            }
          }
          if ($missing.Count -gt 0) {
            throw "Missing required GitHub Actions secrets: $($missing -join ', ')"
          }

      - name: Create or update runtime secrets
        run: |
          kubectl -n $env:NAMESPACE create secret generic dev-tools-secrets `
            --from-literal=MONGODB_URI="$env:MONGODB_URI" `
            --from-literal=JWT_SECRET="$env:JWT_SECRET" `
            --from-literal=ADMIN_USERNAME="$env:ADMIN_USERNAME" `
            --from-literal=ADMIN_PASSWORD="$env:ADMIN_PASSWORD" `
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply manifests
        run: |
          kubectl apply -f deploy/k8s/configmap.yaml
          kubectl apply -f deploy/k8s/cluster-issuer.yaml
          kubectl apply -f deploy/k8s/api.yaml
          kubectl apply -f deploy/k8s/web.yaml
          kubectl apply -f deploy/k8s/ingress.yaml

      - name: Pin deployments to current commit SHA
        run: |
          kubectl -n $env:NAMESPACE set image deployment/api api=$env:IMAGE_API:$env:IMAGE_TAG
          kubectl -n $env:NAMESPACE set image deployment/web web=$env:IMAGE_WEB:$env:IMAGE_TAG

      - name: Wait for rollout
        run: |
          kubectl -n $env:NAMESPACE rollout status deployment/api --timeout=5m
          kubectl -n $env:NAMESPACE rollout status deployment/web --timeout=5m

      - name: Smoke test
        run: |
          curl.exe -fsSI --retry 20 --retry-delay 5 https://www.david-pjetraj.shop/
          curl.exe -fsS --retry 20 --retry-delay 5 https://www.david-pjetraj.shop//v1/health
          $payload = '{"query":"query { __typename }"}'
          curl.exe -fsS --retry 20 --retry-delay 5 -H "Content-Type: application/json" -d $payload https://www.david-pjetraj.shop//graphql

      - name: Roll back if deployment failed
        if: failure()
        continue-on-error: true
        run: |
          kubectl -n $env:NAMESPACE rollout undo deployment/api
          kubectl -n $env:NAMESPACE rollout undo deployment/web
